<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TESTE EMERGENCIAL - CSV Loader</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 8px; max-width: 1200px; }
        .status { padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #cce8ff; color: #004085; border: 1px solid #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; font-size: 12px; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1> TESTE EMERGENCIAL - CSV Loader</h1>
        <p><strong>Objetivo:</strong> Verificar se o data-loader.js corrigido consegue carregar o CSV problemático.</p>
        
        <div id="status">
            <div class="status info">
                <div class="spinner"></div> Iniciando teste...
            </div>
        </div>
        
        <div id="results" style="display: none;">
            <h2> Resultados do Teste</h2>
            <div class="stats" id="statsContainer"></div>
            <div id="detailsContainer"></div>
        </div>
        
        <div style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="runTest()"> Executar Teste</button>
            <button class="btn btn-success" onclick="goToDashboard()"> Ir para Dashboard</button>
            <button class="btn btn-danger" onclick="showDebug()"> Debug Console</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="js/data-loader.js"></script>
    
    <script>
        let testResults = null;
        
        async function runTest() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            console.clear();
            console.log(' STARTING EMERGENCY CSV TEST');
            
            statusDiv.innerHTML = '<div class="status info"><div class="spinner"></div> Carregando CSV...</div>';
            resultsDiv.style.display = 'none';
            
            try {
                // Testar carregamento
                console.log(' Testing CSV load...');
                const startTime = Date.now();
                
                testResults = await window.RM4HealthData.loadData();
                
                const loadTime = Date.now() - startTime;
                
                console.log(' CSV Load SUCCESS!', testResults);
                
                // Mostrar resultados
                statusDiv.innerHTML = `
                    <div class="status success">
                        <h3> CSV CARREGADO COM SUCESSO!</h3>
                        <p><strong>Tempo:</strong> ${loadTime}ms</p>
                        <p><strong>Status:</strong> Dados reais processados corretamente</p>
                    </div>
                `;
                
                // Mostrar estatísticas
                displayResults(testResults);
                resultsDiv.style.display = 'block';
                
            } catch (error) {
                console.error(' TEST FAILED:', error);
                
                statusDiv.innerHTML = `
                    <div class="status error">
                        <h3> FALHA NO TESTE</h3>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <p><strong>Tipo:</strong> ${error.name || 'Error'}</p>
                        <details>
                            <summary>Detalhes técnicos</summary>
                            <pre>${error.stack || 'No stack trace available'}</pre>
                        </details>
                        
                        <h4> Possíveis soluções:</h4>
                        <ul>
                            <li>Verificar se está executando de um servidor HTTP</li>
                            <li>Confirmar que o arquivo CSV existe</li>
                            <li>Verificar console para erros detalhados</li>
                            <li>Testar em navegador diferente</li>
                        </ul>
                    </div>
                `;
            }
        }
        
        function displayResults(data) {
            const statsContainer = document.getElementById('statsContainer');
            const detailsContainer = document.getElementById('detailsContainer');
            
            const stats = data.statistics;
            
            // Cards de estatísticas
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <h4> Participantes</h4>
                    <div style="font-size: 24px; font-weight: bold;">${stats.totalParticipants || 0}</div>
                    <small>Total processados</small>
                </div>
                
                <div class="stat-card">
                    <h4> Aderência</h4>
                    <div style="font-size: 24px; font-weight: bold;">${stats.medicationAdherence?.percentage || 0}%</div>
                    <small>Média de aderência</small>
                </div>
                
                <div class="stat-card">
                    <h4> PSQI Médio</h4>
                    <div style="font-size: 24px; font-weight: bold;">${stats.sleepQuality?.averagePSQI || 0}</div>
                    <small>Qualidade do sono</small>
                </div>
                
                <div class="stat-card">
                    <h4> Alertas</h4>
                    <div style="font-size: 24px; font-weight: bold;">${stats.healthDeterioration?.totalAlerts || 0}</div>
                    <small>Alto risco</small>
                </div>
            `;
            
            // Detalhes adicionais
            detailsContainer.innerHTML = `
                <div class="status info">
                    <h4> Resumo Técnico</h4>
                    <ul>
                        <li><strong>Dados válidos:</strong> ${stats.totalParticipants} registros processados</li>
                        <li><strong>Medicação:</strong> ${stats.medicationAdherence?.participantsWithMedication || 0} com dados</li>
                        <li><strong>Sono:</strong> ${stats.sleepQuality?.participantsWithData || 0} com dados PSQI</li>
                        <li><strong>Utilização:</strong> ${stats.healthcareUtilization?.totalParticipants || 0} com dados</li>
                        <li><strong>Distribuição de risco:</strong> 
                            ${stats.healthDeterioration?.riskDistribution?.high || 0} alto, 
                            ${stats.healthDeterioration?.riskDistribution?.medium || 0} médio, 
                            ${stats.healthDeterioration?.riskDistribution?.low || 0} baixo
                        </li>
                    </ul>
                </div>
                
                <div class="status warning">
                    <h4> Alto Risco (Top 5)</h4>
                    <ul>
                        ${(stats.healthDeterioration?.highRiskParticipants || []).slice(0, 5).map(p => 
                            `<li><strong>${p.id}</strong>: ${p.riskScore}% (${p.factors.join(', ')})</li>`
                        ).join('') || '<li>Nenhum participante de alto risco identificado</li>'}
                    </ul>
                </div>
            `;
        }
        
        function goToDashboard() {
            if (testResults) {
                // Salvar dados para o dashboard
                localStorage.setItem('rm4health_data', JSON.stringify(testResults));
                window.location.href = 'index.html';
            } else {
                alert('Execute o teste primeiro para carregar os dados!');
            }
        }
        
        function showDebug() {
            console.log(' DEBUG INFO:');
            console.log('Test Results:', testResults);
            
            if (window.debugRM4Health) {
                console.log('Data Loader Debug:', window.debugRM4Health());
            }
            
            alert('Informações de debug mostradas no console (F12)');
        }
        
        // Auto-executar teste quando carregar
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runTest, 1000); // Aguardar 1 segundo para scripts carregarem
        });
    </script>
</body>
</html>
