<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíä An√°lise de Ades√£o Medicamentosa - RM4Health</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <style>
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(8.5px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(31, 38, 135, 0.4);
        }
        
        .adherence-high { 
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); 
        }
        .adherence-medium { 
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
        }
        .adherence-low { 
            background: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%); 
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .participant-card {
            border-left: 4px solid #007bff;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .participant-card:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .adherence-badge {
            font-size: 0.8em;
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .timeline-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .medication-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .correlation-item {
            background: linear-gradient(90deg, rgba(0,123,255,0.1) 0%, rgba(0,123,255,0.05) 100%);
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh;">
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line"></i> RM4Health Analytics
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a class="nav-link" href="/longitudinal">
                    <i class="fas fa-chart-line"></i> An√°lise Longitudinal
                </a>
                <a class="nav-link" href="/alerts">
                    <i class="fas fa-exclamation-triangle"></i> Alertas Cl√≠nicos
                </a>
                <a class="nav-link active">
                    <i class="fas fa-pills"></i> Ades√£o Medicamentosa
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-dark text-white">
                    <div class="card-body text-center">
                        <h1><i class="fas fa-pills"></i> An√°lise de Ades√£o Medicamentosa</h1>
                        <p class="lead">Monitoriza√ß√£o detalhada da ades√£o terap√™utica dos participantes RM4Health</p>
                    </div>
                </div>
            </div>
        </div>

        {% if not success %}
        <div class="row">
            <div class="col-12">
                <div class="alert alert-danger">
                    <h4><i class="fas fa-exclamation-triangle"></i> Erro na An√°lise</h4>
                    <p>{{ error }}</p>
                </div>
            </div>
        </div>
        {% else %}

        <!-- M√©tricas Principais -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card adherence-high">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <h3>{{ rates.overall }}%</h3>
                        <p>Taxa Geral de Ades√£o</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <h3>{{ rates.statistics.total_participants or 0 }}</h3>
                        <p>Participantes Analisados</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card adherence-medium">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-pie fa-2x mb-2"></i>
                        <h3>{{ rates.statistics.high_adherence or 0 }}</h3>
                        <p>Alta Ades√£o</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card adherence-low">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <h3>{{ rates.statistics.low_adherence or 0 }}</h3>
                        <p>Baixa Ades√£o</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Abas de An√°lise -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-tabs" id="adherenceTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="rates-tab" data-bs-toggle="tab" data-bs-target="#rates" type="button">
                            <i class="fas fa-percentage"></i> Taxas de Ades√£o
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="factors-tab" data-bs-toggle="tab" data-bs-target="#factors" type="button">
                            <i class="fas fa-search"></i> Fatores Associados
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="adverse-tab" data-bs-toggle="tab" data-bs-target="#adverse" type="button">
                            <i class="fas fa-exclamation-circle"></i> Efeitos Adversos
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="temporal-tab" data-bs-toggle="tab" data-bs-target="#temporal" type="button">
                            <i class="fas fa-clock"></i> Padr√µes Temporais
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Conte√∫do das Abas -->
        <div class="tab-content" id="adherenceTabContent">
            
            <!-- ABA 1: Taxas de Ades√£o -->
            <div class="tab-pane fade show active" id="rates" role="tabpanel">
                <div class="row mt-4">
                    
                    <!-- Gr√°fico de Ades√£o por Participante -->
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-bar"></i> Ades√£o por Participante</h5>
                            </div>
                            <div class="card-body">
                                <div id="participantAdherenceChart"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estat√≠sticas Detalhadas -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-info-circle"></i> Estat√≠sticas</h5>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>M√©dia de Ades√£o:</span>
                                        <strong>{{ rates.statistics.mean_percentage or 0 }}%</strong>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Desvio Padr√£o:</span>
                                        <strong>{{ rates.statistics.std_dev or 0 }}</strong>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Alta Ades√£o (‚â•75%):</span>
                                        <strong class="text-success">{{ rates.statistics.high_adherence or 0 }}</strong>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>M√©dia Ades√£o (50-75%):</span>
                                        <strong class="text-warning">{{ rates.statistics.medium_adherence or 0 }}</strong>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Baixa Ades√£o (<50%):</span>
                                        <strong class="text-danger">{{ rates.statistics.low_adherence or 0 }}</strong>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ades√£o por Medicamento -->
                {% if rates.by_medication %}
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-pills"></i> Ades√£o por Tipo de Medicamento</h5>
                            </div>
                            <div class="card-body">
                                <div id="medicationAdherenceChart"></div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Lista Detalhada de Participantes -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-list"></i> Detalhes por Participante</h5>
                            </div>
                            <div class="card-body">
                                <div class="timeline-container">
                                    {% for participant_id, data in rates.by_participant.items() %}
                                    <div class="participant-card card">
                                        <div class="card-body">
                                            <div class="row align-items-center">
                                                <div class="col-md-3">
                                                    <strong>Participante {{ participant_id }}</strong>
                                                </div>
                                                <div class="col-md-3">
                                                    <span class="adherence-badge 
                                                        {% if data.percentage >= 75 %}bg-success
                                                        {% elif data.percentage >= 50 %}bg-warning
                                                        {% else %}bg-danger{% endif %}">
                                                        {{ data.percentage }}% 
                                                    </span>
                                                </div>
                                                <div class="col-md-3">
                                                    <small class="text-muted">
                                                        N√≠vel: <strong>{{ data.level }}</strong>
                                                    </small>
                                                </div>
                                                <div class="col-md-3">
                                                    <small class="text-muted">
                                                        {{ data.total_records }} registros
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA 2: Fatores Associados -->
            <div class="tab-pane fade" id="factors" role="tabpanel">
                <div class="row mt-4">
                    
                    <!-- Correla√ß√µes -->
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-link"></i> Correla√ß√µes com Outras Vari√°veis</h5>
                            </div>
                            <div class="card-body">
                                {% if factors.correlations %}
                                    {% for variable, correlation in factors.correlations.items() %}
                                    <div class="correlation-item">
                                        <h6>{{ variable|replace('_', ' ')|title }}</h6>
                                        <div class="progress mb-2">
                                            <div class="progress-bar 
                                                {% if correlation > 0.3 %}bg-success
                                                {% elif correlation > 0.1 %}bg-warning  
                                                {% else %}bg-info{% endif %}" 
                                                style="width: {{ ((correlation + 1) / 2 * 100)|round }}%">
                                                {{ correlation }}
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            Correla√ß√£o: 
                                            {% if correlation > 0.3 %}Forte positiva
                                            {% elif correlation > 0.1 %}Moderada positiva
                                            {% elif correlation < -0.3 %}Forte negativa
                                            {% elif correlation < -0.1 %}Moderada negativa
                                            {% else %}Fraca{% endif %}
                                        </small>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                <p class="text-muted">Nenhuma correla√ß√£o significativa encontrada.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fatores de Risco -->
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-warning"></i> Fatores de Impacto na Ades√£o</h5>
                            </div>
                            <div class="card-body">
                                {% if factors.factors.adverse_effects %}
                                    <h6>Efeitos Adversos vs Ades√£o</h6>
                                    {% for effect, data in factors.factors.adverse_effects.items() %}
                                    <div class="medication-item">
                                        <strong>{{ effect }}</strong>
                                        <br>
                                        <span class="badge bg-primary">
                                            Ades√£o m√©dia: {{ data.mean_adherence }}
                                        </span>
                                        <span class="badge bg-secondary">
                                            {{ data.n_participants }} participantes
                                        </span>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                <p class="text-muted">Nenhum fator de risco identificado.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA 3: Efeitos Adversos -->
            <div class="tab-pane fade" id="adverse" role="tabpanel">
                <div class="row mt-4">
                    
                    <!-- Frequ√™ncia de Efeitos Adversos -->
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-pie"></i> Frequ√™ncia de Efeitos Adversos</h5>
                            </div>
                            <div class="card-body">
                                {% if adverse_effects.effects_frequency %}
                                <div id="adverseEffectsChart"></div>
                                {% else %}
                                <p class="text-muted">Nenhum efeito adverso reportado.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Impacto por Severidade -->
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-thermometer-half"></i> Impacto da Severidade na Ades√£o</h5>
                            </div>
                            <div class="card-body">
                                {% if adverse_effects.severity_impact %}
                                    {% for severity, data in adverse_effects.severity_impact.items() %}
                                    <div class="medication-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>{{ severity }}</strong>
                                                <br>
                                                <small class="text-muted">{{ data.n_cases }} casos</small>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge 
                                                    {% if data.adherence_percentage >= 75 %}bg-success
                                                    {% elif data.adherence_percentage >= 50 %}bg-warning
                                                    {% else %}bg-danger{% endif %}">
                                                    {{ data.adherence_percentage }}%
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                <p class="text-muted">Dados de severidade n√£o dispon√≠veis.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Padr√µes de Descontinua√ß√£o -->
                {% if adverse_effects.discontinuation_patterns %}
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-stop-circle"></i> Padr√µes de Descontinua√ß√£o</h5>
                            </div>
                            <div class="card-body">
                                <div id="discontinuationChart"></div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- ABA 4: Padr√µes Temporais -->
            <div class="tab-pane fade" id="temporal" role="tabpanel">
                <div class="row mt-4">
                    
                    <!-- Tend√™ncias Mensais -->
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-line"></i> Evolu√ß√£o Temporal da Ades√£o</h5>
                            </div>
                            <div class="card-body">
                                {% if patterns.monthly_trends %}
                                <div id="temporalTrendsChart"></div>
                                {% else %}
                                <p class="text-muted">Dados temporais insuficientes para an√°lise.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Evolu√ß√£o Individual -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-user-clock"></i> Evolu√ß√£o por Participante</h5>
                            </div>
                            <div class="card-body">
                                <div class="timeline-container">
                                    {% if patterns.adherence_evolution %}
                                        {% for participant_id, evolution in patterns.adherence_evolution.items() %}
                                        <div class="card mb-2">
                                            <div class="card-body p-2">
                                                <div class="d-flex justify-content-between">
                                                    <small><strong>{{ participant_id }}</strong></small>
                                                    <span class="badge 
                                                        {% if evolution.trend == 'Melhorando' %}bg-success
                                                        {% elif evolution.trend == 'Piorando' %}bg-danger
                                                        {% else %}bg-secondary{% endif %}">
                                                        {{ evolution.trend }}
                                                    </span>
                                                </div>
                                                <small class="text-muted">
                                                    Mudan√ßa: {{ evolution.change|round(1) }} pontos
                                                </small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                    <p class="text-muted">Nenhuma evolu√ß√£o temporal detectada.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {% endif %}
        
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Dados do backend
        const rates = {{ rates|tojson }};
        const factors = {{ factors|tojson }};
        const adverseEffects = {{ adverse_effects|tojson }};
        const patterns = {{ patterns|tojson }};
        
        // 1. Gr√°fico de Ades√£o por Participante
        if (rates && rates.by_participant) {
            const participantIds = Object.keys(rates.by_participant);
            const adherencePercentages = participantIds.map(id => rates.by_participant[id].percentage);
            const adherenceColors = adherencePercentages.map(p => 
                p >= 75 ? 'rgba(40, 167, 69, 0.8)' : 
                p >= 50 ? 'rgba(255, 193, 7, 0.8)' : 
                'rgba(220, 53, 69, 0.8)'
            );
            
            const participantChart = {
                x: participantIds,
                y: adherencePercentages,
                type: 'bar',
                marker: {
                    color: adherenceColors,
                    line: {
                        color: 'rgb(8, 48, 107)',
                        width: 1
                    }
                },
                text: adherencePercentages.map(p => p + '%'),
                textposition: 'auto',
            };
            
            const participantLayout = {
                title: 'Taxa de Ades√£o por Participante',
                xaxis: { title: 'Participante' },
                yaxis: { title: 'Ades√£o (%)', range: [0, 100] },
                showlegend: false,
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)'
            };
            
            Plotly.newPlot('participantAdherenceChart', [participantChart], participantLayout, {responsive: true});
        }
        
        // 2. Gr√°fico de Ades√£o por Medicamento
        if (rates && rates.by_medication && Object.keys(rates.by_medication).length > 0) {
            const medications = Object.keys(rates.by_medication);
            const medicationPercentages = medications.map(med => rates.by_medication[med].percentage);
            
            const medicationChart = {
                x: medications,
                y: medicationPercentages,
                type: 'bar',
                marker: {
                    color: 'rgba(54, 162, 235, 0.8)',
                    line: {
                        color: 'rgb(54, 162, 235)',
                        width: 1
                    }
                },
                text: medicationPercentages.map(p => p + '%'),
                textposition: 'auto',
            };
            
            const medicationLayout = {
                title: 'Taxa de Ades√£o por Medicamento',
                xaxis: { title: 'Medicamento' },
                yaxis: { title: 'Ades√£o (%)', range: [0, 100] },
                showlegend: false,
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)'
            };
            
            Plotly.newPlot('medicationAdherenceChart', [medicationChart], medicationLayout, {responsive: true});
        }
        
        // 3. Gr√°fico de Efeitos Adversos
        if (adverseEffects && adverseEffects.effects_frequency && Object.keys(adverseEffects.effects_frequency).length > 0) {
            const effects = Object.keys(adverseEffects.effects_frequency);
            const counts = effects.map(effect => adverseEffects.effects_frequency[effect].count);
            
            const adverseChart = {
                values: counts,
                labels: effects,
                type: 'pie',
                hole: 0.4,
                marker: {
                    colors: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
                }
            };
            
            const adverseLayout = {
                title: 'Distribui√ß√£o de Efeitos Adversos',
                showlegend: true,
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)'
            };
            
            Plotly.newPlot('adverseEffectsChart', [adverseChart], adverseLayout, {responsive: true});
        }
        
        // 4. Gr√°fico de Descontinua√ß√£o
        if (adverseEffects && adverseEffects.discontinuation_patterns && Object.keys(adverseEffects.discontinuation_patterns).length > 0) {
            const reasons = Object.keys(adverseEffects.discontinuation_patterns);
            const reasonCounts = reasons.map(reason => adverseEffects.discontinuation_patterns[reason].count);
            
            const discontinuationChart = {
                x: reasons,
                y: reasonCounts,
                type: 'bar',
                marker: {
                    color: 'rgba(255, 99, 132, 0.8)'
                }
            };
            
            const discontinuationLayout = {
                title: 'Motivos de Descontinua√ß√£o',
                xaxis: { title: 'Motivo' },
                yaxis: { title: 'N√∫mero de Casos' },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)'
            };
            
            Plotly.newPlot('discontinuationChart', [discontinuationChart], discontinuationLayout, {responsive: true});
        }
        
        // 5. Gr√°fico de Tend√™ncias Temporais
        if (patterns && patterns.monthly_trends && Object.keys(patterns.monthly_trends).length > 0) {
            const periods = Object.keys(patterns.monthly_trends);
            const adherenceTrends = periods.map(period => patterns.monthly_trends[period].percentage);
            
            const temporalChart = {
                x: periods,
                y: adherenceTrends,
                type: 'scatter',
                mode: 'lines+markers',
                marker: {
                    color: 'rgba(75, 192, 192, 1)',
                    size: 8
                },
                line: {
                    color: 'rgba(75, 192, 192, 1)',
                    width: 3
                }
            };
            
            const temporalLayout = {
                title: 'Evolu√ß√£o Temporal da Ades√£o',
                xaxis: { title: 'Per√≠odo' },
                yaxis: { title: 'Ades√£o (%)', range: [0, 100] },
                showlegend: false,
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)'
            };
            
            Plotly.newPlot('temporalTrendsChart', [temporalChart], temporalLayout, {responsive: true});
        }
        
        // Auto-refresh (opcional)
        // setInterval(() => location.reload(), 300000); // 5 minutos
    </script>

</body>
</html>
