<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise por Instrumentos - RM4Health Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="bi bi-heart-pulse"></i> RM4Health Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('dashboard') }}"><i class="bi bi-house"></i> Dashboard</a>
                <a class="nav-link" href="{{ url_for('participants') }}"><i class="bi bi-people"></i> Participantes</a>
                <a class="nav-link" href="{{ url_for('data_explorer') }}"><i class="bi bi-table"></i> Explorador</a>
                <a class="nav-link" href="{{ url_for('analytics') }}"><i class="bi bi-graph-up"></i> An√°lises</a>
                <a class="nav-link active" href="{{ url_for('instruments') }}"><i class="bi bi-clipboard-data"></i> Instrumentos</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2><i class="bi bi-clipboard-data text-primary"></i> An√°lise por Instrumentos</h2>
                <p class="text-muted">An√°lise detalhada dos formul√°rios e question√°rios do estudo RM4Health</p>
                
                <!-- Explica√ß√£o para leigos -->
                <div class="alert alert-info mb-4">
                    <h5><i class="bi bi-info-circle"></i> O que s√£o Instrumentos de Avalia√ß√£o?</h5>
                    <p class="mb-2"><strong>Para leigos:</strong> Os instrumentos s√£o question√°rios ou escalas cient√≠ficas validadas que usamos para medir diferentes aspetos da sa√∫de dos participantes de forma objetiva e padronizada.</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-clipboard-check text-primary"></i> Tipos de Instrumentos no RM4Health:</h6>
                            <ul class="mb-0">
                                <li><strong>Funcionais:</strong> Avaliam independ√™ncia nas atividades di√°rias (ex: Barthel)</li>
                                <li><strong>Qualidade de Vida:</strong> Medem bem-estar geral (ex: EQ-5D)</li>
                                <li><strong>Sono:</strong> Analisam qualidade do sono (ex: Pittsburgh)</li>
                                <li><strong>Socioecon√≥micos:</strong> Caracterizam perfil social e econ√≥mico</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-graph-up text-success"></i> Como Interpretar os Dados:</h6>
                            <ul class="mb-0">
                                <li><strong>Taxa de Participa√ß√£o:</strong> % de pessoas que responderam</li>
                                <li><strong>Completude:</strong> Se os question√°rios foram totalmente preenchidos</li>
                                <li><strong>Distribui√ß√£o:</strong> Como os dados se espalham pelos participantes</li>
                                <li><strong>Qualidade:</strong> Se as respostas fazem sentido e s√£o v√°lidas</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if success and instruments %}
        <!-- Resumo Geral -->
        <div class="row mb-4">
            <div class="col-12">
                <h3><i class="bi bi-bar-chart text-primary"></i> Resumo Geral dos Instrumentos</h3>
                <div class="alert alert-light border">
                    <p class="mb-2"><strong>üí° Para leigos:</strong> Estas m√©tricas mostram a "sa√∫de" geral da recolha de dados do estudo.</p>
                    <ul class="mb-0">
                        <li><strong>Instrumentos Ativos:</strong> Quantos question√°rios diferentes estamos a usar</li>
                        <li><strong>Total de Registros:</strong> Quantas vezes os question√°rios foram preenchidos</li>
                        <li><strong>Total de Participa√ß√µes:</strong> Quantos participantes √∫nicos responderam</li>
                        <li><strong>M√©dia por Instrumento:</strong> Em m√©dia, quantas respostas cada question√°rio tem</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h3>{{ instruments|length }}</h3>
                        <p class="mb-1">Instrumentos Ativos</p>
                        <small>{% if instruments|length >= 10 %}Excelente diversidade{% elif instruments|length >= 5 %}Boa cobertura{% else %}Limitado{% endif %}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h3>{{ instruments.values() | map(attribute='total_records') | sum }}</h3>
                        <p class="mb-1">Total de Registros</p>
                        <small>{% set total = instruments.values() | map(attribute='total_records') | sum %}{% if total >= 500 %}Volume alto{% elif total >= 200 %}Volume moderado{% else %}Volume baixo{% endif %}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h3>{{ instruments.values() | map(attribute='participants_list') | list | map('length') | sum if instruments else 0 }}</h3>
                        <p class="mb-1">Total de Participa√ß√µes</p>
                        <small>{% set parts = instruments.values() | map(attribute='participants_list') | list | map('length') | sum %}{% if parts >= 20 %}Boa ades√£o{% elif parts >= 10 %}Ades√£o moderada{% else %}Baixa ades√£o{% endif %}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h3>{{ (instruments.values() | map(attribute='total_records') | sum) / instruments|length if instruments|length > 0 else 0 | round(1) }}</h3>
                        <p class="mb-1">M√©dia por Instrumento</p>
                        <small>{% set avg = (instruments.values() | map(attribute='total_records') | sum) / instruments|length if instruments|length > 0 else 0 %}{% if avg >= 50 %}Muito usado{% elif avg >= 20 %}Bem usado{% else %}Pouco usado{% endif %}</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°fico de Distribui√ß√£o -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Distribui√ß√£o de Registros por Instrumento</h5>
                    </div>
                    <div class="card-body">
                        <div id="instrumentsChart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detalhes por Instrumento -->
        {% for instrument_key, instrument_data in instruments.items() %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="mb-0">
                                    <i class="bi bi-clipboard-check text-primary"></i>
                                    {{ instrument_data.name }}
                                </h5>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-primary me-2">{{ instrument_data.total_records }} registros</span>
                                <span class="badge bg-info">{{ instrument_data.unique_participants }} participantes</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Explica√ß√£o para leigos de cada instrumento -->
                        <div class="alert alert-light border-start border-primary border-3 mb-3">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6><i class="bi bi-lightbulb text-primary"></i> O que este instrumento avalia:</h6>
                                    {% if 'barthel' in instrument_key.lower() %}
                                    <p class="mb-1"><strong>√çndice de Barthel:</strong> Mede a independ√™ncia nas atividades b√°sicas da vida di√°ria como comer, vestir-se, tomar banho, caminhar e usar o banheiro. Pontua√ß√£o de 0-100.</p>
                                    <small class="text-muted">üéØ √ötil para: Avaliar se a pessoa consegue cuidar de si mesma no dia a dia</small>
                                    {% elif 'eq5d' in instrument_key.lower() %}
                                    <p class="mb-1"><strong>EQ-5D:</strong> Avalia qualidade de vida em 5 dimens√µes: mobilidade, cuidados pessoais, atividades habituais, dor/mal-estar e ansiedade/depress√£o.</p>
                                    <small class="text-muted">üéØ √ötil para: Medir o bem-estar geral e impacto da doen√ßa na vida</small>
                                    {% elif 'pittsburgh' in instrument_key.lower() or 'sono' in instrument_key.lower() %}
                                    <p class="mb-1"><strong>√çndice de Qualidade do Sono de Pittsburgh:</strong> Avalia a qualidade do sono, lat√™ncia, dura√ß√£o, efici√™ncia e dist√∫rbios do sono.</p>
                                    <small class="text-muted">üéØ √ötil para: Identificar problemas de sono que afetam a sa√∫de</small>
                                    {% elif 'caracterizacao' in instrument_key.lower() %}
                                    <p class="mb-1"><strong>Caracteriza√ß√£o Socioecon√≥mica:</strong> Recolhe informa√ß√µes sobre educa√ß√£o, profiss√£o, rendimento, habita√ß√£o e situa√ß√£o familiar.</p>
                                    <small class="text-muted">üéØ √ötil para: Entender o contexto social que influencia a sa√∫de</small>
                                    {% elif 'preferencias' in instrument_key.lower() %}
                                    <p class="mb-1"><strong>Prefer√™ncias e H√°bitos:</strong> Avalia rotinas di√°rias, atividades preferidas e padr√µes de comportamento.</p>
                                    <small class="text-muted">üéØ √ötil para: Personalizar cuidados baseados nos gostos da pessoa</small>
                                    {% elif 'medicacao' in instrument_key.lower() %}
                                    <p class="mb-1"><strong>Ades√£o √† Medica√ß√£o:</strong> Monitoriza se a pessoa toma os medicamentos corretamente e como se sente.</p>
                                    <small class="text-muted">üéØ √ötil para: Garantir que o tratamento est√° a ser seguido</small>
                                    {% elif 'utilizacao' in instrument_key.lower() and 'servicos' in instrument_key.lower() %}
                                    <p class="mb-1"><strong>Utiliza√ß√£o de Servi√ßos:</strong> Regista consultas m√©dicas, idas ao hospital, emerg√™ncias e outros cuidados de sa√∫de.</p>
                                    <small class="text-muted">üéØ √ötil para: Analisar custos e necessidades de cuidados</small>
                                    {% elif 'tecnologias' in instrument_key.lower() %}
                                    <p class="mb-1"><strong>Tecnologias de Sa√∫de:</strong> Avalia familiaridade com dispositivos como tensi√≥metros, glic√≥metros, aplica√ß√µes m√≥veis.</p>
                                    <small class="text-muted">üéØ √ötil para: Implementar solu√ß√µes tecnol√≥gicas adequadas</small>
                                    {% elif 'participante' in instrument_key.lower() %}
                                    <p class="mb-1"><strong>Dados do Participante:</strong> Informa√ß√µes b√°sicas como idade, sexo, diagn√≥sticos e grupo de estudo.</p>
                                    <small class="text-muted">üéØ √ötil para: Caracterizar a amostra do estudo</small>
                                    {% else %}
                                    <p class="mb-1"><strong>{{ instrument_data.name }}:</strong> Instrumento de avalia√ß√£o validado para medir aspetos espec√≠ficos da sa√∫de e bem-estar.</p>
                                    <small class="text-muted">üéØ √ötil para: Recolher dados objetivos e compar√°veis</small>
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    <h6><i class="bi bi-speedometer2 text-success"></i> Performance deste instrumento:</h6>
                                    {% set participation_rate = (instrument_data.unique_participants / 23 * 100) if 23 > 0 else 0 %}
                                    {% if participation_rate >= 80 %}
                                    <span class="badge bg-success">Excelente - {{ participation_rate|round(1) }}% participa√ß√£o</span>
                                    <p class="small mt-1">Quase todos os participantes responderam!</p>
                                    {% elif participation_rate >= 60 %}
                                    <span class="badge bg-warning">Bom - {{ participation_rate|round(1) }}% participa√ß√£o</span>
                                    <p class="small mt-1">A maioria dos participantes respondeu.</p>
                                    {% elif participation_rate >= 40 %}
                                    <span class="badge bg-orange">Moderado - {{ participation_rate|round(1) }}% participa√ß√£o</span>
                                    <p class="small mt-1">Cerca de metade dos participantes respondeu.</p>
                                    {% else %}
                                    <span class="badge bg-danger">Baixo - {{ participation_rate|round(1) }}% participa√ß√£o</span>
                                    <p class="small mt-1">Poucos participantes responderam.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Lista de Participantes -->
                            <div class="col-md-6">
                                <h6><i class="bi bi-people"></i> Participantes ({{ instrument_data.unique_participants }})</h6>
                                <p class="small text-muted mb-2">üí° Lista dos c√≥digos dos participantes que responderam a este question√°rio:</p>
                                <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                                    {% for participant in instrument_data.participants_list %}
                                    <span class="badge bg-light text-dark me-1 mb-1">{{ participant }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Campos mais preenchidos -->
                            <div class="col-md-6">
                                <h6><i class="bi bi-check-square"></i> Campos Mais Preenchidos</h6>
                                <p class="small text-muted mb-2">üí° Perguntas que mais participantes responderam (maior ades√£o):</p>
                                <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                                    {% for field, count in instrument_data.top_fields.items() %}
                                    {% if loop.index <= 8 %}
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small>{{ field[:30] }}{% if field|length > 30 %}...{% endif %}</small>
                                        <span class="badge bg-secondary">{{ count }}</span>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Taxa de Preenchimento por Participante -->
                        <div class="mt-3">
                            <h6><i class="bi bi-graph-up"></i> Engajamento dos Participantes</h6>
                            <p class="small text-muted mb-2">üí° Percentagem de participantes do estudo que responderam a este question√°rio:</p>
                            <div class="progress-stacked">
                                {% set participation_rate = (instrument_data.unique_participants / 23 * 100) if 23 > 0 else 0 %}
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" 
                                         style="width: {{ participation_rate }}%" 
                                         title="Taxa de participa√ß√£o: {{ participation_rate|round(1) }}%">
                                        {{ participation_rate|round(1) }}% dos participantes
                                    </div>
                                </div>
                            </div>
                            {% if participation_rate >= 80 %}
                            <small class="text-success">‚úÖ Excelente ades√£o! Este instrumento teve muito sucesso.</small>
                            {% elif participation_rate >= 60 %}
                            <small class="text-warning">‚ö†Ô∏è Boa ades√£o, mas pode melhorar.</small>
                            {% else %}
                            <small class="text-danger">üîç Baixa ades√£o - precisa investigar porqu√™.</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- An√°lise Metodol√≥gica e Recomenda√ß√µes -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-mortarboard"></i> An√°lise Metodol√≥gica e Recomenda√ß√µes Cient√≠ficas</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle"></i> Como foi calculado (Metodologia Cient√≠fica):</h6>
                            <ol>
                                <li><strong>Identifica√ß√£o de Instrumentos:</strong> An√°lise de campos "*_complete" nos dados REDCap para identificar question√°rios √∫nicos</li>
                                <li><strong>Taxa de Participa√ß√£o:</strong> (Participantes √∫nicos por instrumento √∑ Total de participantes) √ó 100</li>
                                <li><strong>Qualidade dos Dados:</strong> An√°lise de completude baseada em valores '2' (completo) vs '1' (incompleto) ou '0' (n√£o iniciado)</li>
                                <li><strong>Distribui√ß√£o de Campos:</strong> Contagem de frequ√™ncia de preenchimento por vari√°vel</li>
                            </ol>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="bi bi-check-circle text-success"></i> Pontos Fortes Identificados:</h6>
                                <ul>
                                    {% set total_instruments = instruments|length %}
                                    {% set avg_participation = (instruments.values() | map(attribute='unique_participants') | sum) / total_instruments if total_instruments > 0 else 0 %}
                                    {% if total_instruments >= 8 %}
                                    <li>‚úÖ <strong>Diversidade excelente:</strong> {{ total_instruments }} instrumentos cobrem m√∫ltiplas dimens√µes da sa√∫de</li>
                                    {% endif %}
                                    {% if avg_participation >= 15 %}
                                    <li>‚úÖ <strong>Boa ades√£o:</strong> M√©dia de {{ avg_participation|round(1) }} participantes por instrumento</li>
                                    {% endif %}
                                    <li>‚úÖ <strong>Valida√ß√£o cient√≠fica:</strong> Uso de instrumentos padronizados e validados</li>
                                    <li>‚úÖ <strong>Abordagem multidimensional:</strong> Avalia√ß√£o funcional, qualidade de vida, sono e fatores sociais</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="bi bi-exclamation-triangle text-warning"></i> Recomenda√ß√µes para Melhoria:</h6>
                                <ul>
                                    {% if avg_participation < 20 %}
                                    <li>‚ö†Ô∏è <strong>Aumentar ades√£o:</strong> Implementar estrat√©gias para aumentar participa√ß√£o</li>
                                    {% endif %}
                                    <li>üìä <strong>Monitoriza√ß√£o cont√≠nua:</strong> Acompanhar taxas de completude em tempo real</li>
                                    <li>üéØ <strong>Prioriza√ß√£o:</strong> Focar nos instrumentos com menor ades√£o</li>
                                    <li>üì± <strong>Tecnologia:</strong> Considerar interfaces mais user-friendly</li>
                                    <li>üë• <strong>Forma√ß√£o:</strong> Treinar equipa para melhor suporte aos participantes</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <h6><i class="bi bi-journal-medical text-primary"></i> Refer√™ncias Cient√≠ficas para esta An√°lise:</h6>
                            <div class="small">
                                <p class="mb-1">üìñ <strong>Proctor, E. et al. (2011).</strong> Outcomes for implementation research: conceptual distinctions, measurement challenges, and research agenda. <em>Administration and Policy in Mental Health</em>, 38(2), 65-76. <a href="https://doi.org/10.1007/s10488-010-0319-7" target="_blank" class="text-decoration-none">DOI: 10.1007/s10488-010-0319-7</a></p>
                                <p class="mb-1">üìñ <strong>Harris, P.A. et al. (2009).</strong> Research electronic data capture (REDCap) - A metadata-driven methodology and workflow process for providing translational research informatics support. <em>Journal of Biomedical Informatics</em>, 42(2), 377-381.</p>
                                <p class="mb-0">üìñ <strong>Kahn, M.G. et al. (2016).</strong> A Harmonized Data Quality Assessment Terminology and Framework for the Secondary Use of Electronic Health Record Data. <em>EGEMS</em>, 4(1), 1244.</p>
                            </div>
                        </div>
                        
                        <div class="mt-3 p-3 bg-light rounded">
                            <h6><i class="bi bi-lightbulb text-warning"></i> Interpreta√ß√£o para Tomada de Decis√µes:</h6>
                            {% set overall_quality = (instruments.values() | map(attribute='unique_participants') | sum) / (total_instruments * 23) * 100 if total_instruments > 0 else 0 %}
                            {% if overall_quality >= 80 %}
                            <p class="mb-1"><strong>üèÜ EXCELENTE:</strong> O estudo tem dados de alta qualidade com boa representatividade. Adequado para an√°lises robustas e publica√ß√µes cient√≠ficas.</p>
                            {% elif overall_quality >= 60 %}
                            <p class="mb-1"><strong>‚úÖ BOM:</strong> O estudo tem dados s√≥lidos mas com margem para melhorias. Adequado para a maioria das an√°lises planeadas.</p>
                            {% elif overall_quality >= 40 %}
                            <p class="mb-1"><strong>‚ö†Ô∏è MODERADO:</strong> Os dados s√£o utiliz√°veis mas precisam de estrat√©gias para melhorar a completude e representatividade.</p>
                            {% else %}
                            <p class="mb-1"><strong>üîç ATEN√á√ÉO:</strong> A qualidade dos dados precisa melhorias significativas antes de an√°lises conclusivas.</p>
                            {% endif %}
                            <small class="text-muted">Qualidade geral calculada: {{ overall_quality|round(1) }}% (baseada na participa√ß√£o m√©dia ponderada)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <!-- Estado de erro -->
        <div class="row">
            <div class="col-12">
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle"></i> Erro ao Carregar Instrumentos</h5>
                    {% if error %}
                    <p><strong>Erro:</strong> {{ error }}</p>
                    {% else %}
                    <p>N√£o foi poss√≠vel carregar os dados dos instrumentos.</p>
                    {% endif %}
                    <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                        <i class="bi bi-house"></i> Voltar ao Dashboard
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    {% if success and instruments %}
    <script>
        // Gr√°fico de distribui√ß√£o de instrumentos
        const instrumentsData = [
            {
                x: [{% for instrument_key, instrument_data in instruments.items() %}'{{ instrument_data.name }}'{% if not loop.last %},{% endif %}{% endfor %}],
                y: [{% for instrument_key, instrument_data in instruments.items() %}{{ instrument_data.total_records }}{% if not loop.last %},{% endif %}{% endfor %}],
                type: 'bar',
                marker: {
                    color: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14']
                }
            }
        ];

        const layout = {
            title: false,
            xaxis: { 
                title: 'Instrumentos',
                tickangle: -45
            },
            yaxis: { title: 'N√∫mero de Registros' },
            margin: { t: 20, b: 100, l: 60, r: 20 }
        };

        Plotly.newPlot('instrumentsChart', instrumentsData, layout, {responsive: true});
    </script>
    {% endif %}
</body>
</html>
