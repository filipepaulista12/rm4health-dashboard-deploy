<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise por Grupos - RM4Health Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="bi bi-heart-pulse"></i> RM4Health Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('dashboard') }}"><i class="bi bi-house"></i> Dashboard</a>
                <a class="nav-link" href="{{ url_for('participants') }}"><i class="bi bi-people"></i> Participantes</a>
                <a class="nav-link" href="{{ url_for('data_explorer') }}"><i class="bi bi-table"></i> Explorador</a>
                <a class="nav-link" href="{{ url_for('analytics') }}"><i class="bi bi-graph-up"></i> Análises</a>
                <a class="nav-link active" href="{{ url_for('groups') }}"><i class="bi bi-people-fill"></i> Grupos</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2><i class="bi bi-people-fill text-primary"></i> Análise por Grupos</h2>
                <p class="text-muted">Comparação entre grupos de participantes do estudo RM4Health</p>
            </div>
        </div>

        {% if success and groups %}
        <!-- Resumo Geral -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h3>{{ groups|length }}</h3>
                        <p class="mb-0">Grupos Identificados</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h3>{{ groups.values() | map(attribute='total_participants') | sum }}</h3>
                        <p class="mb-0">Total de Participantes</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h3>{{ groups.values() | map(attribute='total_records') | sum }}</h3>
                        <p class="mb-0">Total de Registros</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h3>{{ (groups.values() | map(attribute='total_records') | sum) / (groups.values() | map(attribute='total_participants') | sum) if (groups.values() | map(attribute='total_participants') | sum) > 0 else 0 | round(1) }}</h3>
                        <p class="mb-0">Registros/Participante</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfico de Distribuição -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Distribuição de Participantes</h5>
                    </div>
                    <div class="card-body">
                        <div id="participantsChart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Registros por Grupo</h5>
                    </div>
                    <div class="card-body">
                        <div id="recordsChart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detalhes por Grupo -->
        {% for group_name, group_data in groups.items() %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="mb-0">
                                    <i class="bi bi-people text-primary"></i>
                                    {{ group_name if group_name else "Grupo Não Especificado" }}
                                </h5>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-info me-2">{{ group_data.total_participants }} participantes</span>
                                <span class="badge bg-primary">{{ group_data.total_records }} registros</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Lista de Participantes -->
                            <div class="col-md-4">
                                <h6><i class="bi bi-person-lines-fill"></i> Participantes ({{ group_data.total_participants }})</h6>
                                <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                                    {% for participant in group_data.participants_list %}
                                    <span class="badge bg-light text-dark me-1 mb-1">{{ participant }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Distribuição por Instrumentos -->
                            <div class="col-md-4">
                                <h6><i class="bi bi-clipboard-data"></i> Instrumentos Utilizados</h6>
                                <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                                    {% for instrument, count in group_data.instruments_distribution.items() %}
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small>{{ instrument[:25] }}{% if instrument|length > 25 %}...{% endif %}</small>
                                        <span class="badge bg-secondary">{{ count }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- Demografia (se disponível) -->
                            <div class="col-md-4">
                                <h6><i class="bi bi-person-badge"></i> Demografia</h6>
                                <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                                    {% if group_data.demographics %}
                                        {% for demo, count in group_data.demographics.items() %}
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small>{{ demo }}</small>
                                            <span class="badge bg-info">{{ count }}</span>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                    <small class="text-muted">Dados demográficos não disponíveis</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Métricas do Grupo -->
                        <div class="mt-3">
                            <h6><i class="bi bi-graph-up"></i> Métricas do Grupo</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card border-info">
                                        <div class="card-body text-center p-2">
                                            <h6 class="card-title mb-1">{{ (group_data.total_records / group_data.total_participants) | round(1) }}</h6>
                                            <small class="text-muted">Registros por Participante</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-success">
                                        <div class="card-body text-center p-2">
                                            <h6 class="card-title mb-1">{{ group_data.instruments_distribution|length }}</h6>
                                            <small class="text-muted">Instrumentos Únicos</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-warning">
                                        <div class="card-body text-center p-2">
                                            <h6 class="card-title mb-1">{{ (group_data.total_participants / (groups.values() | map(attribute='total_participants') | sum) * 100) | round(1) }}%</h6>
                                            <small class="text-muted">% do Total</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-primary">
                                        <div class="card-body text-center p-2">
                                            <h6 class="card-title mb-1">{{ group_data.instruments_distribution.values() | list | max if group_data.instruments_distribution and group_data.instruments_distribution.values() | list else 0 }}</h6>
                                            <small class="text-muted">Max Registros/Instrumento</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Comparações entre Grupos -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-bar-chart-steps"></i> Comparação entre Grupos</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Grupo</th>
                                        <th>Participantes</th>
                                        <th>Registros</th>
                                        <th>Registros/Participante</th>
                                        <th>Instrumentos</th>
                                        <th>% do Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for group_name, group_data in groups.items() %}
                                    <tr>
                                        <td><strong>{{ group_name if group_name else "Não especificado" }}</strong></td>
                                        <td><span class="badge bg-info">{{ group_data.total_participants }}</span></td>
                                        <td><span class="badge bg-primary">{{ group_data.total_records }}</span></td>
                                        <td>{{ (group_data.total_records / group_data.total_participants) | round(1) }}</td>
                                        <td>{{ group_data.instruments_distribution|length }}</td>
                                        <td>{{ (group_data.total_participants / (groups.values() | map(attribute='total_participants') | sum) * 100) | round(1) }}%</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <!-- Estado de erro -->
        <div class="row">
            <div class="col-12">
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle"></i> Erro ao Carregar Grupos</h5>
                    {% if error %}
                    <p><strong>Erro:</strong> {{ error }}</p>
                    {% else %}
                    <p>Não foi possível carregar os dados dos grupos.</p>
                    {% endif %}
                    <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                        <i class="bi bi-house"></i> Voltar ao Dashboard
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    {% if success and groups %}
    <script>
        // Gráfico de pizza - participantes por grupo
        const participantsData = [{
            values: [{% for group_name, group_data in groups.items() %}{{ group_data.total_participants }}{% if not loop.last %},{% endif %}{% endfor %}],
            labels: [{% for group_name, group_data in groups.items() %}'{{ group_name if group_name else "Não especificado" }}'{% if not loop.last %},{% endif %}{% endfor %}],
            type: 'pie',
            textinfo: 'label+percent',
            marker: {
                colors: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1']
            }
        }];

        const participantsLayout = {
            title: false,
            margin: { t: 20, b: 20, l: 20, r: 20 },
            showlegend: false
        };

        Plotly.newPlot('participantsChart', participantsData, participantsLayout, {responsive: true});

        // Gráfico de barras - registros por grupo
        const recordsData = [{
            x: [{% for group_name, group_data in groups.items() %}'{{ group_name if group_name else "Não especificado" }}'{% if not loop.last %},{% endif %}{% endfor %}],
            y: [{% for group_name, group_data in groups.items() %}{{ group_data.total_records }}{% if not loop.last %},{% endif %}{% endfor %}],
            type: 'bar',
            marker: {
                color: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1']
            }
        }];

        const recordsLayout = {
            title: false,
            xaxis: { 
                title: 'Grupos',
                tickangle: -45
            },
            yaxis: { title: 'Registros' },
            margin: { t: 20, b: 100, l: 60, r: 20 }
        };

        Plotly.newPlot('recordsChart', recordsData, recordsLayout, {responsive: true});
    </script>
    {% endif %}
</body>
</html>
